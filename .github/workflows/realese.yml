# TRABAJO 3: ANDROID (Firmado y Optimizado)
  build-android:
    name: 3. Build Android
    needs: bump-version
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Instalar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependencias
        run: npm install

      - name: Construir Web
        run: npm run build

      - name: Sincronizar Capacitor
        run: npx cap sync android

      # Restaurar la llave desde los secretos de GitHub
      - name: Restaurar Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/release.keystore

      - name: Dar permisos a Gradlew
        run: chmod +x android/gradlew

      # Construir versi√≥n RELEASE firmada
      - name: Generar APK Firmado
        run: cd android && ./gradlew assembleRelease -Pandroid.injected.signing.store.file=$(pwd)/release.keystore -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }} -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: Subir APK Final
        uses: actions/upload-artifact@v4
        with:
          name: Instalador-Android
          # Nota: Ahora la ruta es 'release' en lugar de 'debug'
          path: android/app/build/outputs/apk/release/app-release.apk
